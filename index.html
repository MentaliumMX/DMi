<!DOCTYPE html>
<html lang="es">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Tablero DM — Modular</title>
<link rel="icon" type="image/png" href="Tablero-DM.png"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="./Tablero DM_files/css2" rel="stylesheet"/>
<style>
:root{
  --bg:#f6f8fc; --ink:#0f172a; --muted:#6b7280; --line:#e6ecf5; --card:#fff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
h1{margin:0 0 4px;font-size:24px}
.sub{color:var(--muted);font-size:13px;margin-bottom:16px}
  
/* --- Scroll horizontal para móvil --- */
@media (max-width: 768px) {
  .quick-grid {
    display: flex !important;
    gap: 16px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 12px;
  }
  .quick-grid::-webkit-scrollbar {
    height: 8px;
  }
  .quick-grid::-webkit-scrollbar-thumb {
    background: #c3c7d1;
    border-radius: 8px;
  }
  .card {
    flex: 0 0 220px !important;
    scroll-snap-align: start;
    min-width: 220px;
  }
}

/* Tarjetas */
.quick-grid{
  display:grid;
  gap:16px;
  grid-template-columns:repeat(3,minmax(0,1fr)); /* 3 por fila */
}
@media(max-width:1100px){.quick-grid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:900px){.quick-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:640px){.quick-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:430px){.quick-grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;cursor:pointer;box-shadow:0 1px 2px rgba(2,6,23,.04);transition:.2s transform}
.card:hover{transform:translateY(-2px)}
.card .thumb{height:140px;border-radius:12px;background:#eef5ff;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;color:#37599b}
.card h3{margin:10px 0 2px;font-size:16px}
.card p{margin:0;color:var(--muted);font-size:13px}

/* Escenario dinámico */
.stage{background:var(--card);border:1px solid var(--line);border-radius:16px;margin-top:20px;padding:10px}
.view{display:none;--thead-bg:#3c7f8b;--thead-fg:#fff}
.view.active{display:block}

/* Tablas */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.pretty{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
.pretty th,.pretty td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top;font-size:14px}
.pretty thead th{background:var(--thead-bg,#f1f5fb);text-align:left;color:var(--thead-fg,#1f2a44);font-weight:600}
.pretty tbody tr:last-child td{border-bottom:none}

/* Acomodadores trae estilos inline en <thead>; aquí los domamos sin afectar otras vistas */
.view[data-view="acomodadores"] .pretty thead{background:var(--thead-bg) !important;color:var(--thead-fg) !important;}
.view[data-view="acomodadores"] .pretty thead th{background:var(--thead-bg) !important;color:var(--thead-fg) !important;border:none !important;}

/* Tema por vista (colores de encabezado de tabla) */
.view[data-view="fds"]{--thead-bg:#3c7f8b;--thead-fg:#fff}


/* --- ETIQUETAS (TAGS) --- */
.tag {
  display: block;
  text-align: center;
  background: #eef5ff;
  color: #374a79;
  border: 1px solid #d9e5ff;
  padding: 12px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  margin: 16px 0;
  line-height: 1.5;
}

/* Botones y modal para “No Tocar” */
.btn{background:#0ea5e9;border:1px solid #0793ce;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.ghost{background:#fff;color:#0b539b;border-color:#cfe6fb}
.dm-select{min-width:200px;max-width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font:inherit;background:#fff;color:var(--ink);height:40px}
.actions{display:flex;gap:10px;justify-content:flex-end;margin:8px 0 12px}
.backdrop{position:fixed;inset:0;background:rgba(2,6,23,.42);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal{background:#fff;max-width:720px;width:100%;border:1px solid var(--line);border-radius:14px;padding:16px}
.modal h3{margin:0 0 10px} .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{display:block;font-size:13px;color:#22314f;margin:8px 0 4px} input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font:inherit;background:#fff}
textarea{min-height:120px;resize:vertical}
.sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.small{font-size:12px;color:#6b7280}

/* Territorio & Anuncios */
.territorio-wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.territorio-wrap{grid-template-columns:1fr}}
.territorio-wrap img{width:100%;height:auto;border-radius:12px;border:1px solid var(--line)}
.anuncios{display:flex;flex-direction:column;gap:12px}
.item{background:#f9fbff;border:1px solid var(--line);border-radius:12px;padding:12px}
.item .fecha{color:#6b7280;font-size:13px;margin-bottom:2px}
.item .titulo{font-weight:700}

/* =============================
   REUNIÓN ENTRE SEMANA
   ============================= */
.section-es .bloque {
  border-radius: 14px;
  overflow: hidden;
  margin-bottom: 24px;
  box-shadow: 0 3px 6px rgba(15,23,42,.12);
}
.section-es .bloque h3 {
  margin: 0;
  padding: 10px 16px;
  color: #fff;
  font-size: 15px;
  font-weight: 600;
  letter-spacing: .4px;
}
.section-es .bloque table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}
.section-es .bloque th, .section-es .bloque td {
  padding: 10px 14px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 14px;
}
.section-es .bloque tbody tr:last-child td {
  border-bottom: none;
}
.section-es .bloque.azul h3 {background:#3c7f8b;}
.section-es .bloque.naranja h3 {background:#bf8702;}
.section-es .bloque.vino h3 {background:#bf8702;}

/* Estilo para acomodadores */
.section-es .tabla-mes {
  border-radius: 14px;
  overflow: hidden;
  margin-bottom: 22px;
  box-shadow: 0 3px 6px rgba(15,23,42,.12);
}

.section-es .tabla-mes h4 {
  margin: 0;
  padding: 10px 16px;
  color: #fff;
  font-size: 16px;
  font-weight: 700;
}
  
.section-es table.pretty-mes {
  width: 100%;
  border-collapse: collapse;
}
.section-es table.pretty-mes th, .section-es table.pretty-mes td {
  padding: 10px 12px;
  text-align: left;
  font-size: 14px;
}
	
.thumb img {
  width: 65%;
  height: 100%;
  object-fit: contain;
  border-radius: 12px;
}

.section-es .tabla-oct h4 {background:#f59e0b;}
.section-es .tabla-oct tbody tr:nth-child(odd) {background:#fef3c7;}
.section-es .tabla-oct tbody tr:nth-child(even) {background:#fffbeb;}
</style>
<style id="operaUserStyle" type="text/css"></style><script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
// === EmailJS Config ===
// Reemplaza estos valores por los tuyos
const EMAILJS_PUBLIC_KEY = '_25pFZCJ-8ysLQL5o';
const EMAILJS_SERVICE_ID = 'service_yhprqed';
const EMAILJS_TEMPLATE_ID = 'template_r1ol1ui';

document.addEventListener('DOMContentLoaded', function(){
  try {
    if (typeof emailjs !== 'undefined' && EMAILJS_PUBLIC_KEY && !EMAILJS_PUBLIC_KEY.includes('PASTE_')) {
      emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
      console.log('EmailJS listo');
    } else {
      console.warn('EmailJS no inicializado: agrega tus claves.');
    }
  } catch(err){
    console.error('Error inicializando EmailJS', err);
  }
});
</script>

</head>
<body>
  <div class="container">
    <h1>Congregación Diaz Mirón</h1>
    <p class="sub">Infomación de la congregación Diaz Mirón</p>
    <div class="quick-grid" id="quickGrid">
<div class="card" data-target="fds"><div class="thumb"> <img alt="Fin de Semana" src="ICONOS/COLOR/Ico-RFS.svg"/></div><h3>Reunión de fin de semana</h3><p>Programa y acomodadores.</p></div>
<div class="card" data-target="es"><div class="thumb"> <img alt="Entre Semana" src="ICONOS/COLOR/Ico-RES.svg"/></div><h3>Reunión entre semana</h3><p>Programa y acoomodadores.</p></div>
<div class="card" data-target="acomodadores"><div class="thumb"><img alt="Entre Semana" src="ICONOS/COLOR/ICO-AC.svg"/></div><h3>Acomodadores</h3><p>Programa por mes.</p></div>
<div class="card" data-target="anuncios"><div class="thumb"> <img alt="Anuncios" src="ICONOS/COLOR/ICO-A.svg"/></div><h3>Tablero de anuncios</h3><p>Próximos eventos.</p></div>
<div class="card" data-target="territorio"><div class="thumb"> <img alt="Territorio" src="ICONOS/COLOR/ICO-M.svg"/></div><h3>Territorio</h3><p>Mapas Díaz Mirón.</p></div>
<div class="card" data-target="notocar"><div class="thumb"> <img alt="NO Tocar" src="ICONOS/COLOR/ICO-NT.svg" width="2"/></div><h3>NO TOCAR</h3><p>Direcciones del Territorio.</p></div>
</div>

    <div class="stage">
  <div class="view" data-view="fds" data-src="blocks/reunion-fin-semana.html"></div>
  <div class="view" data-view="es" data-src="blocks/reunion-entre-semana.html"></div>
  <div class="view" data-view="acomodadores" data-src="blocks/acomodadores.html"></div>
  <div class="view" data-view="territorio" data-src="blocks/territorio.html"></div>
  <div class="view" data-view="anuncios" data-src="blocks/anuncios.html"></div>
  <div class="view" data-view="notocar" data-src="blocks/no-tocar.html"></div>
    </div>
  </div>

  <div class="backdrop" id="backdrop">
<div class="modal">
<h3>Reportar “No Tocar”</h3>
<p class="small">Completa los campos. Al enviar, se abrirá un correo listo para mandar a <strong>live24a@gmail.com</strong>.</p>
<form id="reportForm">
<input aria-hidden="true" autocomplete="off" id="hp" name="hp" style="position:absolute;left:-9999px;opacity:0;" tabindex="-1" type="text"/>
<div class="row">
<div><label>Territorio</label><input name="territorio" required=""/></div>
<div><label>Calle / Depto.</label><input name="calle" required=""/></div>
</div>
<div class="row">
<div><label>Número</label><input name="numero"/></div>
<div><label>Responsable (quien reporta)</label><input name="responsable" required=""/></div>
</div>
<label>Detalles</label>
<textarea name="detalles" placeholder="Descripción breve de por qué no se toca, colores de puerta, referencias, etc."></textarea>
<div class="form-actions">
<button class="btn ghost" id="cancel" type="button">Cancelar</button>
<button class="btn" type="submit">Enviar por correo</button>
</div>
</form>
</div>
</div>

  
<script>
(() => {
  const quickGrid = document.getElementById('quickGrid');

  function setActive(view){
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const sec = document.querySelector('.view[data-view="'+view+'"]');
    if (!sec) return;
    sec.classList.add('active');
  }

  function runPostProcess(view, sec){
    try{
      if(view === "es"){
        applyEntreSemanaHeaderColors();
        filterFromCurrentWeekOnward(sec);
      } else if(view === "fds"){
        splitFdsIntoTablesByMonth(sec);
        filterFromCurrentWeekOnward(sec);
      } else if(view === "acomodadores"){
        filterAcomodadoresFromCurrentWeekOnward(sec);
      } else if(view === "notocar"){
        initNoTocarTerritorioFilter(sec);
      }
    }catch(err){
      console.warn("Post-process error:", view, err);
    }
  }

  async function loadView(view){
    const sec = document.querySelector('.view[data-view="'+view+'"]');
    if (!sec) return;
    if (sec.dataset.loaded === '1') return;

    const src = sec.dataset.src;
    if (!src) return;

    sec.innerHTML = '<p class="sub">Cargando…</p>';

    const res = await fetch(src, { cache: 'no-cache' });
    if (!res.ok) throw new Error('No se pudo cargar '+src);

    sec.innerHTML = await res.text();
    sec.dataset.loaded = '1';

    // post-procesos por bloque
    runPostProcess(view, sec);
  }

  function show(view){
    setActive(view);
    const _secNow = document.querySelector(".view[data-view=\""+view+"\"]");
    if(_secNow && _secNow.dataset.loaded === "1"){ runPostProcess(view, _secNow); }
    loadView(view).catch(err => {
      const sec = document.querySelector('.view[data-view="'+view+'"]');
      if (sec) sec.innerHTML = '<p class="sub">Error: '+(err?.message || 'No se pudo cargar el bloque')+'</p>';
    });
    location.hash = view;
  }

  // Click en tarjetas
  if (quickGrid){
    quickGrid.addEventListener('click', (e) => {
      const card = e.target.closest('.card[data-target]');
      if (!card) return;
      show(card.getAttribute('data-target'));
    });
  }

  // Arranque
  const initial = (location.hash || '').replace('#','') || 'fds';
  show(initial);

  // Si el navegador restaura la página desde cache (bfcache), re-aplicamos post-procesos
  window.addEventListener("pageshow", (ev)=>{
    if(ev && ev.persisted){
      const active = document.querySelector(".view.active");
      if(active){
        const v = active.getAttribute("data-view");
        if(v) runPostProcess(v, active);
      }
    }
  });

  // Mantén el hash navegable (atrás/adelante)
  window.addEventListener('hashchange', () => {
    const view = (location.hash || '').replace('#','') || 'fds';
    show(view);
  });

  // ====== Modal “No Tocar” (event delegation para soportar carga dinámica) ======
  const bd = document.getElementById('backdrop');
  document.addEventListener('click', (e) => {
    if (!bd) return;

    const openBtn = e.target.closest('#openReport, [data-action="open-report"]');
    if (openBtn) {
      bd.style.display = 'flex';
      return;
    }

    const cancelBtn = e.target.closest('#cancel, [data-action="close-report"]');
    if (cancelBtn) {
      bd.style.display = 'none';
      return;
    }

    // clic fuera del modal = cerrar
    if (e.target === bd) {
      bd.style.display = 'none';
    }
  });

  // ====== Envío con EmailJS (con fallback a mailto) ======
  const form = document.getElementById('reportForm');
  if (form) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn ? submitBtn.textContent : null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);

      // Honeypot: si está relleno, no enviamos
      if ((fd.get('hp') || '').trim() !== '') {
        console.warn('Honeypot activado — envío cancelado');
        return;
      }

      // UI: bloquea durante el envío
      if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Enviando…'; }

      const to = 'live24a@gmail.com';
      const subject = 'Reporte NO TOCAR — Territorio ' + (fd.get('territorio') || '');
      const bodyLines = [
        'Territorio: ' + (fd.get('territorio') || ''),
        'Calle / Depto.: ' + (fd.get('calle') || ''),
        'Número: ' + (fd.get('numero') || ''),
        'Detalles: ' + (fd.get('detalles') || ''),
        'Reportado por: ' + (fd.get('responsable') || '')
      ];
      const body = bodyLines.join('\n');

      const templateParams = {
        to_email: to,
        subject: subject,
        cuerpo: body,
        territorio: fd.get('territorio') || '',
        calle: fd.get('calle') || '',
        numero: fd.get('numero') || '',
        detalles: fd.get('detalles') || '',
        responsable: fd.get('responsable') || ''
      };

      const emailjsReady = (typeof emailjs !== 'undefined')
        && typeof EMAILJS_PUBLIC_KEY !== 'undefined'
        && typeof EMAILJS_SERVICE_ID !== 'undefined'
        && typeof EMAILJS_TEMPLATE_ID !== 'undefined'
        && EMAILJS_PUBLIC_KEY
        && EMAILJS_SERVICE_ID
        && EMAILJS_TEMPLATE_ID
        && !String(EMAILJS_PUBLIC_KEY).includes('PASTE_');

      async function fallbackMailto(){
        const href = 'mailto:' + to
          + '?subject=' + encodeURIComponent(subject)
          + '&body=' + encodeURIComponent(body);
        window.location.href = href;
      }

      try {
        if (emailjsReady) {
          const res = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
          console.log('EmailJS OK', res);
          alert('¡Reporte enviado! Gracias por la información.');
        } else {
          console.warn('EmailJS no configurado — usando mailto como respaldo.');
          await fallbackMailto();
        }

        e.target.reset();
        const bd = document.getElementById('backdrop');
        if (bd) bd.style.display = 'none';
      } catch (err) {
        console.error('Error enviando con EmailJS:', err);
        alert('No se pudo enviar por EmailJS. Intentaremos con tu app de correo.');
        await fallbackMailto();
      } finally {
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalText || 'Enviar por correo'; }
      }
    });
  }


  // ====== Filtro: mostrar desde la semana actual en adelante (Lunes→Domingo) ======
  function startOfWeekMonday(d = new Date()) {
    const date = new Date(d);
    date.setHours(0,0,0,0);
    const day = date.getDay(); // 0=Dom,1=Lun,...6=Sáb
    const diff = (day === 0 ? -6 : 1 - day);
    date.setDate(date.getDate() + diff);
    return date;
  }

  function parseISODateLocal(iso) {
    // iso: "YYYY-MM-DD"
    const parts = (iso || '').split('-').map(Number);
    if (parts.length !== 3 || parts.some(n => Number.isNaN(n))) return null;
    const [y,m,d] = parts;
    return new Date(y, m-1, d, 0,0,0,0);
  }

  function filterFromCurrentWeekOnward(rootEl) {
    if (!rootEl) return;
    const threshold = startOfWeekMonday(new Date());

    // Entre semana: bloques completos
    rootEl.querySelectorAll('.week-block[data-date]').forEach(block => {
      const dt = parseISODateLocal(block.getAttribute('data-date'));
      if (!dt) return;
      block.style.display = (dt < threshold) ? 'none' : '';
    });

    // Fin de semana: filas
    rootEl.querySelectorAll('tr[data-date]').forEach(row => {
      const dt = parseISODateLocal(row.getAttribute('data-date'));
      if (!dt) return;
      row.style.display = (dt < threshold) ? 'none' : '';
    });
  }

  // ====== Fin de semana: separar la tabla por mes (una tabla por mes) ======
  function splitFdsIntoTablesByMonth(rootEl){
    if (!rootEl) return;
    const table = rootEl.querySelector('#tablaFDS');
    if (!table) return;

    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if (!thead || !tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr'));
    if (!rows.length) return;

    // Agrupar por texto de la primera columna (Mes)
    const groups = new Map();
    rows.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if (!tds.length) return;
      const mes = (tds[0].textContent || '').trim() || 'Sin mes';
      if (!groups.has(mes)) groups.set(mes, []);
      groups.get(mes).push(tr);
    });

    const wrap = table.closest('.table-wrap');
    if (!wrap) return;
    const parent = wrap.parentElement;
    if (!parent) return;

    // Evita ejecutar dos veces
    if (parent.dataset.fdsSplit === '1') return;
    parent.dataset.fdsSplit = '1';

    // Quitar tabla original (para reemplazarla por tablas mensuales)
    wrap.remove();

    groups.forEach((trs, mes) => {
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.textContent = mes;
      parent.appendChild(tag);

      const newWrap = document.createElement('div');
      newWrap.className = 'table-wrap';

      const newTable = document.createElement('table');
      newTable.className = 'pretty';
      newTable.appendChild(thead.cloneNode(true));

      const newTbody = document.createElement('tbody');
      trs.forEach(tr => newTbody.appendChild(tr)); // mueve filas
      newTable.appendChild(newTbody);

      newWrap.appendChild(newTable);
      parent.appendChild(newWrap);
    });
  }


  // ====== Acomodadores: filtrar desde semana actual (lunes) ======
  function filterAcomodadoresFromCurrentWeekOnward(rootEl){
    if(!rootEl) return;
    const threshold = startOfWeekMonday(new Date());

    const monthMap = {
      "enero":0,"febrero":1,"marzo":2,"abril":3,"mayo":4,"junio":5,
      "julio":6,"agosto":7,"septiembre":8,"setiembre":8,"octubre":9,"noviembre":10,"diciembre":11
    };

    const year = (new Date()).getFullYear();

    // Caso A: estructura nueva (envoltorios .tabla-mes + h4)
    const boxes = Array.from(rootEl.querySelectorAll(".tabla-mes"));
    if(boxes.length){
      boxes.forEach(box=>{
        const monthTitle = ((box.querySelector("h4")||{}).textContent || "").trim().toLowerCase();
        const monthIdx = monthMap[monthTitle];
        const table = box.querySelector("table");
        const rows = table ? Array.from(table.querySelectorAll("tbody tr")) : [];
        let anyVisible = false;

        rows.forEach(tr=>{
          // Soporta data-date="YYYY-MM-DD" (más confiable)
          const ds = (tr.getAttribute('data-date')||'').trim();
          let dt = null;
          if(ds){
            dt = new Date(ds + 'T00:00:00');
          } else {
            const firstCell = (tr.children[0] ? tr.children[0].textContent : "").trim();
            const m = firstCell.match(/(\d{1,2})/);
            if(monthIdx == null || !m){
              tr.style.display = "";
              anyVisible = true;
              return;
            }
            const day = Number(m[1]);
            dt = new Date(year, monthIdx, day);
          }
          const show = dt && !isNaN(dt.getTime()) && dt >= threshold;
          tr.style.display = show ? "" : "none";
          if(show) anyVisible = true;
        });

        box.style.display = anyVisible ? "" : "none";
      });
      return;
    }

    // Caso B: estructura anterior (varias tablas .pretty por mes, título en thead th[colspan])
    const tables = Array.from(rootEl.querySelectorAll('table.pretty'));
    tables.forEach(table=>{
      const monthTh = table.querySelector('thead th[colspan]');
      const monthTitle = (monthTh ? monthTh.textContent : '').trim().toLowerCase();
      const monthIdx = monthMap[monthTitle];
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      let anyVisible = false;

      rows.forEach(tr=>{
        const ds = (tr.getAttribute('data-date')||'').trim();
        let dt = null;
        if(ds){
          dt = new Date(ds + 'T00:00:00');
        } else {
          const firstCell = (tr.children[0] ? tr.children[0].textContent : '').trim();
          const m = firstCell.match(/(\d{1,2})/);
          if(monthIdx == null || !m){
            tr.style.display = '';
            anyVisible = true;
            return;
          }
          const day = Number(m[1]);
          dt = new Date(year, monthIdx, day);
        }
        const show = dt && !isNaN(dt.getTime()) && dt >= threshold;
        tr.style.display = show ? '' : 'none';
        if(show) anyVisible = true;
      });

      // Si una tabla queda vacía, la escondemos también
      const wrap = table.closest('.table-wrap') || table;
      wrap.style.display = anyVisible ? '' : 'none';
    });
  }

  // ====== Colores “Reunión entre semana” ======
  function applyEntreSemanaHeaderColors(){
    document.querySelectorAll('.view[data-view="es"] thead').forEach(thead => {
      const firstTh = thead.querySelector('th:first-child');
      if (!firstTh) return;

      const text = (firstTh.textContent || '').trim().toLowerCase();
      let color = '';

      if (text.includes('tesoros de la biblia')) color = '#3c7f8b';
      else if (text.includes('seamos mejores maestros')) color = '#bf8702';
      else if (text.includes('nuestra vida cristiana')) color = '#7c0125';

      if (color) {
        thead.querySelectorAll('th').forEach(th => {
          th.style.background = color;
          th.style.color = '#fff';
          th.style.border = 'none';
        });
      }
    });
  }

  // ====== Filtro por Territorio (NO TOCAR) ======
  function initNoTocarTerritorioFilter(rootEl){
    if (!rootEl) return;

    const select = rootEl.querySelector('#territorioFilter');
    const clearBtn = rootEl.querySelector('#clearTerritorioFilter');
    const tbody = rootEl.querySelector('#noTocarBody');
    if (!select || !tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr'));

    // 1) Poblar opciones con territorios únicos
    const territories = [...new Set(rows
      .map(r => (r.children[0]?.textContent || '').trim())
      .filter(Boolean)
    )];

    territories.sort((a,b) => {
      const na = Number(a), nb = Number(b);
      const aNum = !Number.isNaN(na), bNum = !Number.isNaN(nb);
      if (aNum && bNum) return na - nb;
      if (aNum) return -1;
      if (bNum) return 1;
      return a.localeCompare(b, 'es');
    });

    // Limpia (dejando el "Todos")
    const keepFirst = select.querySelector('option[value="all"]');
    select.innerHTML = '';
    select.appendChild(keepFirst || new Option('Todos los territorios', 'all'));
    territories.forEach(t => select.appendChild(new Option('Territorio ' + t, t)));

    function applyFilter(value){
      const v = (value || 'all').trim();
      rows.forEach(r => {
        const t = (r.children[0]?.textContent || '').trim();
        r.style.display = (v === 'all' || t === v) ? '' : 'none';
      });
    }

    // 2) Eventos
    select.addEventListener('change', () => applyFilter(select.value));
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        select.value = 'all';
        applyFilter('all');
      });
    }

    // Estado inicial
    applyFilter(select.value);
  }
})();
</script>

</body>
</html>
